<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω D·ªãch v·ª•</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

    <header class="bg-blue-600 text-white py-6 text-center shadow">
        <h1 class="text-3xl font-bold">H·ªá th·ªëng Qu·∫£n l√Ω Kh√°ch s·∫°n</h1>
    </header>

    <nav class="bg-white shadow flex justify-center gap-6 py-4 text-blue-700 font-semibold">
        <a href="index.html">Trang ch√≠nh</a>
        <a href="khachhang.html">Kh√°ch h√†ng</a>
        <a href="phong.html">Ph√≤ng</a>
        <a href="dichvu.html" class="underline text-blue-900">D·ªãch v·ª•</a>
        <a href="hoadon.html">H√≥a ƒë∆°n</a>
        <a href="datphong.html">ƒê·∫∑t ph√≤ng</a>
    </nav>

    <main class="p-6 max-w-6xl mx-auto space-y-4">

        <div class="flex gap-2">
            <input id="searchInput" type="text" placeholder="T√¨m t√™n d·ªãch v·ª•..." class="border px-3 py-2 rounded w-full" />
            <button onclick="fetchAndRenderDV()" class="bg-blue-600 text-white px-4 py-2 rounded">T·∫£i l·∫°i</button>
            <button onclick="openForm()" class="bg-green-600 text-white px-4 py-2 rounded">+ Th√™m</button>
        </div>

        <div class="overflow-auto bg-white shadow rounded">
            <table class="w-full text-sm">
                <thead class="bg-gray-200 text-gray-700">
                    <tr>
                        <th class="p-2 text-center">M√£</th>
                        <th class="p-2 text-left">T√™n</th>
                        <th class="p-2 text-right">Gi√°</th>
                        <th class="p-2 text-left">M√¥ t·∫£</th>
                        <th class="p-2 text-center">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="dvTable"></tbody> </table>
        </div>

        <div id="formPopup" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
            <div class="bg-white p-6 rounded shadow w-full max-w-md">
                <h2 class="text-xl font-bold mb-4" id="formTitle">Th√™m D·ªãch v·ª•</h2>
                <form id="dvForm" class="space-y-3">
                    <input type="hidden" id="ma_dv" />
                    <input id="ten_dv" placeholder="T√™n d·ªãch v·ª•" required class="w-full border px-3 py-2 rounded" />
                    <input id="don_gia" placeholder="Gi√°" type="number" required class="w-full border px-3 py-2 rounded" />
                    <textarea id="mo_ta" placeholder="M√¥ t·∫£ d·ªãch v·ª•" class="w-full border px-3 py-2 rounded"></textarea>
                    <div class="text-right mt-2 space-x-2">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-1 rounded">L∆∞u</button>
                        <button type="button" onclick="closeForm()" class="bg-gray-500 text-white px-4 py-1 rounded">H·ªßy</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="detailPopup" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
            <div class="bg-white p-6 rounded shadow w-full max-w-md">
                <h2 class="text-xl font-bold mb-4">Chi ti·∫øt D·ªãch v·ª•</h2>
                <div id="detailContent" class="text-sm space-y-1"></div>
                <div class="text-right mt-4">
                    <button onclick="closeDetail()" class="bg-blue-600 text-white px-4 py-1 rounded">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // H√†m ƒë·ªÉ t·∫£i v√† hi·ªÉn th·ªã d·ªØ li·ªáu d·ªãch v·ª•
        async function fetchAndRenderDV() {
            const search = document.getElementById("searchInput").value.toLowerCase();
            const tbody = document.getElementById("dvTable");
            tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>`;

            try {
                // Th√™m tham s·ªë t√¨m ki·∫øm v√†o URL n·∫øu c√≥ gi√° tr·ªã
                const url = search ? `/api/dichvu?search=${encodeURIComponent(search)}` : '/api/dichvu';
                // ƒê·∫£m b·∫£o kh√¥ng d√πng cache khi fetch d·ªØ li·ªáu
                const res = await fetch(url, { cache: 'no-cache' }); 
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const services = await res.json();
                
                tbody.innerHTML = ""; // X√≥a th√¥ng b√°o "ƒêang t·∫£i"

                if (services.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y d·ªãch v·ª• n√†o.</td></tr>`;
                    return;
                }

                services.forEach(d => {
                    const tr = document.createElement("tr");
                    tr.className = "border-t";
                    
                    const giaHienThi = d.don_gia ? parseFloat(d.don_gia).toLocaleString('vi-VN') + ' ƒë' : '0 ƒë';
                    
                    tr.innerHTML = `
                        <td class="p-2 text-center">${d.ma_dv}</td>
                        <td class="p-2 text-left">${d.ten_dv}</td>
                        <td class="p-2 text-right">${giaHienThi}</td>
                        <td class="p-2 text-left">${d.mo_ta || '‚Äî'}</td>
                        <td class="p-2 space-x-1 text-center">
                            <button onclick='viewDV(${JSON.stringify(d)})' class="text-blue-600 hover:underline">üëÅ</button>
                            <button onclick='editDV(${JSON.stringify(d)})' class="text-yellow-600 hover:underline">‚úè</button>
                            <button onclick='deleteDV("${d.ma_dv}")' class="text-red-600 hover:underline">üóë</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(error) {
                console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error);
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</td></tr>`;
            }
        }

        function openForm() {
            document.getElementById("dvForm").reset();
            document.getElementById("ma_dv").value = "";
            document.getElementById("formTitle").innerText = "Th√™m D·ªãch v·ª•";
            document.getElementById("formPopup").classList.remove("hidden");
            document.getElementById("formPopup").classList.add("flex");
        }

        function closeForm() {
            document.getElementById("formPopup").classList.add("hidden");
            document.getElementById("formPopup").classList.remove("flex");
        }

        function editDV(dv) {
            openForm();
            document.getElementById("formTitle").innerText = "S·ª≠a D·ªãch v·ª•";
            document.getElementById("ma_dv").value = dv.ma_dv;
            document.getElementById("ten_dv").value = dv.ten_dv;
            document.getElementById("don_gia").value = dv.don_gia;
            document.getElementById("mo_ta").value = dv.mo_ta;
        }

        function viewDV(d) {
            const div = document.getElementById("detailContent");
            const giaHienThi = d.don_gia ? parseFloat(d.don_gia).toLocaleString('vi-VN') + ' ƒë' : '0 ƒë';
            div.innerHTML = `
                <p><b>M√£ DV:</b> ${d.ma_dv}</p>
                <p><b>T√™n:</b> ${d.ten_dv}</p>
                <p><b>Gi√°:</b> ${giaHienThi}</p>
                <p><b>M√¥ t·∫£:</b> ${d.mo_ta || '‚Äî'}</p>
            `;
            document.getElementById("detailPopup").classList.remove("hidden");
            document.getElementById("detailPopup").classList.add("flex");
        }

        function closeDetail() {
            document.getElementById("detailPopup").classList.add("hidden");
            document.getElementById("detailPopup").classList.remove("flex");
        }

        async function deleteDV(ma_dv) {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° d·ªãch v·ª• n√†y kh√¥ng?")) {
                try {
                    const res = await fetch('/api/dichvu/' + ma_dv, { method: 'DELETE' });
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    alert("X√≥a d·ªãch v·ª• th√†nh c√¥ng!");
                    fetchAndRenderDV(); // T·∫£i l·∫°i d·ªØ li·ªáu sau khi x√≥a
                } catch (error) {
                    console.error("L·ªói khi x√≥a d·ªãch v·ª•:", error);
                    alert("C√≥ l·ªói x·∫£y ra khi x√≥a d·ªãch v·ª•. Vui l√≤ng th·ª≠ l·∫°i.");
                }
            }
        }

        document.getElementById("dvForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const body = {
                ten_dv: document.getElementById("ten_dv").value,
                don_gia: Number(document.getElementById("don_gia").value),
                mo_ta: document.getElementById("mo_ta").value,
            };
            const ma_dv = document.getElementById("ma_dv").value;
            const method = ma_dv ? 'PUT' : 'POST';
            const url = ma_dv ? '/api/dichvu/' + ma_dv : '/api/dichvu';

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                alert(ma_dv ? "C·∫≠p nh·∫≠t d·ªãch v·ª• th√†nh c√¥ng!" : "Th√™m d·ªãch v·ª• th√†nh c√¥ng!");
                closeForm();
                fetchAndRenderDV(); // T·∫£i l·∫°i d·ªØ li·ªáu sau khi th√™m/s·ª≠a
            } catch (error) {
                console.error("L·ªói khi l∆∞u d·ªãch v·ª•:", error);
                alert("C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªãch v·ª•. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        });

        // G·∫Øn s·ª± ki·ªán 'input' ƒë·ªÉ t√¨m ki·∫øm t·ª©c th√¨
        document.getElementById('searchInput').addEventListener('input', fetchAndRenderDV);

        // T·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu khi trang ƒë∆∞·ª£c m·ªü
        fetchAndRenderDV();
    </script>

</body>
</html>