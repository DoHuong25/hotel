<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Đặt Phòng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tùy chỉnh nhỏ cho sidebar nếu cần, hoặc để Tailwind tự xử lý */
        .sidebar ul li a.active {
            color: #1d4ed8; /* blue-700 */
            text-decoration: underline;
            font-weight: bold;
        }
        /* Ẩn các nút mũi tên trên input number */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-blue-600 text-white py-6 text-center shadow">
        <h1 class="text-3xl font-bold">Hệ thống Quản lý Khách sạn</h1>
    </header>

    <nav class="bg-white shadow flex justify-center gap-6 py-4 text-blue-700 font-semibold">
        <a href="index.html" class="hover:text-blue-900">Trang chính</a>
        <a href="khachhang.html" class="hover:text-blue-900">Khách hàng</a>
        <a href="phong.html" class="hover:text-blue-900">Phòng</a>
        <a href="dichvu.html" class="hover:text-blue-900">Dịch vụ</a>
        <a href="datphong.html" class="underline text-blue-900">Đặt phòng</a>
        <a href="hoadon.html" class="hover:text-blue-900">Hóa đơn</a>
    </nav>

    <main class="p-6 max-w-6xl mx-auto space-y-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Phiếu đặt phòng</h2>

        <div class="bg-white p-6 rounded-lg shadow space-y-4">
            <h3 class="text-lg font-semibold text-gray-700">Thông tin khách hàng</h3>
            <div class="flex items-center space-x-4">
                <label class="inline-flex items-center">
                    <input type="radio" name="khOption" value="cu" checked class="form-radio text-blue-600 h-4 w-4" />
                    <span class="ml-2 text-gray-700">Khách hàng cũ</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="khOption" value="moi" class="form-radio text-blue-600 h-4 w-4" />
                    <span class="ml-2 text-gray-700">Khách hàng mới</span>
                </label>
            </div>

            <div id="khachHangCu" class="space-y-3">
                <input type="text" id="searchKH" placeholder="Tìm theo tên hoặc SĐT khách hàng cũ..." class="border border-gray-300 px-3 py-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <select id="khachCuSelect" class="border border-gray-300 px-3 py-2 rounded-md w-full bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Đang tải khách hàng --</option>
                </select>
            </div>

            <div id="khachHangMoi" class="space-y-3 hidden">
                <input type="text" id="tenKH" placeholder="Tên khách hàng" required class="border border-gray-300 px-3 py-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <input type="text" id="sdtKH" placeholder="SĐT (10 số)" pattern="[0-9]{10}" title="Số điện thoại phải có 10 chữ số" required class="border border-gray-300 px-3 py-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <input type="text" id="cmndKH" placeholder="CCCD (12 số)" pattern="[0-9]{12}" title="CCCD phải có 12 chữ số" required class="border border-gray-300 px-3 py-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <label for="ngaySinhKH" class="text-gray-700">Ngày sinh:</label>
                <input type="date" id="ngaySinhKH" required class="border border-gray-300 px-3 py-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <input type="text" id="diaChiKH" placeholder="Địa chỉ" class="border border-gray-300 px-3 py-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <select id="gioiTinhKH" class="border border-gray-300 px-3 py-2 rounded-md w-full bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Chọn giới tính --</option>
                    <option value="nam">Nam</option>
                    <option value="nữ">Nữ</option>
                    <option value="khác">Khác</option>
                </select>
                <input type="text" id="quocTichKH" placeholder="Quốc tịch" class="border border-gray-300 px-3 py-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow space-y-4">
            <h3 class="text-lg font-semibold text-gray-700">Thông tin phòng và thời gian</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="ngayDat" class="block text-gray-700 text-sm font-bold mb-2">Ngày đặt:</label>
                    <input type="date" id="ngayDat" required class="border border-gray-300 px-3 py-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                    <label for="ngayNhan" class="block text-gray-700 text-sm font-bold mb-2">Ngày nhận phòng:</label>
                    <input type="date" id="ngayNhan" required class="border border-gray-300 px-3 py-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                    <label for="ngayTra" class="block text-gray-700 text-sm font-bold mb-2">Ngày trả phòng:</label>
                    <input type="date" id="ngayTra" required class="border border-gray-300 px-3 py-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
            </div>

            <div>
                <label for="phongSelectionContainer" class="block text-gray-700 text-sm font-bold mb-2">Chọn phòng trống:</label>
                <div id="phongSelectionContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-gray-500">Vui lòng chọn Ngày nhận và Ngày trả phòng.</p>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow space-y-4">
            <h3 class="text-lg font-semibold text-gray-700">Thông tin thanh toán và Nhân viên</h3>
            <select id="hinhThucThanhToan" class="border border-gray-300 px-3 py-2 rounded-md w-full bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- Chọn hình thức thanh toán --</option>
                <option value="cash">Tiền mặt</option>
                <option value="banking">Chuyển khoản</option>
                <option value="momo">MoMo</option>
                <option value="zalopay">ZaloPay</option>
            </select>
            <select id="maNVThucHien" class="border border-gray-300 px-3 py-2 rounded-md w-full bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- Chọn nhân viên thực hiện --</option>
                <!-- Options sẽ được tải động bằng JavaScript -->
            </select>
        </div>

        <div class="bg-white p-6 rounded-lg shadow space-y-4">
            <h3 class="text-lg font-semibold text-gray-700">Chọn dịch vụ đi kèm</h3>
            <div id="dichVuContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p class="text-gray-500">Đang tải dịch vụ...</p>
            </div>
        </div>
        
        <div class="text-center">
            <button onclick="datPhong()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                Xác nhận đặt phòng
            </button>
        </div>
    </main>

    <script>
        // Global variables to store fetched data
        let allCustomers = [];
        let allServices = [];
        let allEmployees = []; // Để lưu danh sách nhân viên

        // --- Event Listeners for UI interaction ---
        document.querySelectorAll('input[name="khOption"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const isNewCustomer = document.querySelector('input[name="khOption"]:checked').value === 'moi';
                document.getElementById('khachHangCu').classList.toggle('hidden', isNewCustomer);
                document.getElementById('khachHangMoi').classList.toggle('hidden', !isNewCustomer);

                // Reset new customer form when switching back to old customer
                if (!isNewCustomer) {
                    document.getElementById('khachHangMoi').querySelectorAll('input, select, textarea').forEach(input => input.value = '');
                }
            });
        });

        document.getElementById('searchKH').addEventListener('input', function () {
            const keyword = this.value.toLowerCase();
            const filtered = allCustomers.filter(kh => 
                kh.ten_kh.toLowerCase().includes(keyword) || (kh.sdt && kh.sdt.includes(keyword))
            );
            renderCustomerSelect(filtered);
        });

        // Lắng nghe sự kiện thay đổi trên các input ngày để tải lại phòng
        document.getElementById('ngayNhan').addEventListener('change', updateAvailableRooms);
        document.getElementById('ngayTra').addEventListener('change', updateAvailableRooms);

        async function updateAvailableRooms() {
            const ngayNhan = document.getElementById('ngayNhan').value;
            const ngayTra = document.getElementById('ngayTra').value;

            // Chỉ tải phòng nếu cả hai ngày đã được chọn
            if (ngayNhan && ngayTra) {
                // Kiểm tra hợp lệ của ngày trước khi gọi API
                const d_ngayNhan = new Date(ngayNhan);
                const d_ngayTra = new Date(ngayTra);
                // Đảm bảo ngày trả phải SAU ngày nhận. Nếu không, hiển thị lỗi và không tải phòng.
                if (d_ngayNhan >= d_ngayTra) {
                    document.getElementById('phongSelectionContainer').innerHTML = '<p class="text-red-500">Ngày trả phòng phải sau Ngày nhận phòng.</p>';
                    return;
                }
                loadAvailableRooms(ngayNhan, ngayTra);
            } else {
                document.getElementById('phongSelectionContainer').innerHTML = '<p class="text-gray-500">Vui lòng chọn Ngày nhận và Ngày trả phòng.</p>';
            }
        }
        async function loadOldCustomers() {
            try {
                const selectElement = document.getElementById('khachCuSelect');
                selectElement.innerHTML = '<option value="">-- Đang tải khách hàng --</option>'; // Show loading state

                const res = await fetch('/api/khachhang', { cache: 'no-cache' });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP error! status: ${res.status}, body: ${errorText}`);
                }
                allCustomers = await res.json();
                renderCustomerSelect(allCustomers);
            } catch (error) {
                console.error("Lỗi tải danh sách khách hàng:", error);
                document.getElementById('khachCuSelect').innerHTML = '<option value="">Lỗi tải khách hàng</option>';
                alert(`Lỗi khi tải danh sách khách hàng: ${error.message}. Vui lòng kiểm tra console.`);
            }
        }

        function renderCustomerSelect(customersList) {
            const selectElement = document.getElementById('khachCuSelect');
            selectElement.innerHTML = '<option value="">-- Chọn khách hàng cũ --</option>'; // Reset options

            if (customersList.length === 0) {
                selectElement.innerHTML += '<option value="">Không tìm thấy khách hàng</option>';
                return;
            }

            customersList.forEach(kh => {
                const option = document.createElement('option');
                option.value = kh.ma_kh;
                option.textContent = `${kh.ten_kh} - ${kh.sdt || 'Không có SĐT'}`;
                selectElement.appendChild(option);
            });
        }

        async function loadAvailableRooms(ngayNhan, ngayTra) {
            try {
                const container = document.getElementById('phongSelectionContainer');
                container.innerHTML = '<p class="text-gray-500">Đang tải phòng trống...</p>';

                // Truyền ngày nhận và ngày trả vào query parameters
                const url = `/api/phong?ngay_nhan=${encodeURIComponent(ngayNhan)}&ngay_tra=${encodeURIComponent(ngayTra)}`;
                const res = await fetch(url, { cache: 'no-cache' });

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP error! status: ${res.status}, body: ${errorText}`);
                }
                const rooms = await res.json();
                console.log("Dữ liệu phòng từ API (theo ngày):", rooms);
                
                container.innerHTML = ''; // Clear loading message

                if (rooms.length === 0) { // Không còn là availableRooms.filter nữa, backend đã lọc
                    container.innerHTML = '<p class="text-gray-500">Không có phòng trống trong khoảng thời gian này.</p>';
                    return;
                }

                rooms.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2 border p-3 rounded-md bg-gray-50';
                    const giaPhong = typeof p.gia === 'number' ? p.gia.toLocaleString('vi-VN') : 'N/A';
                    div.innerHTML = `
                        <input type="checkbox" id="room_${p.ma_phong}" value="${p.ma_phong}" name="selectedRooms" class="form-checkbox h-4 w-4 text-blue-600" />
                        <label for="room_${p.ma_phong}" class="flex-grow text-gray-800">Phòng ${p.so_phong} - ${p.loai_phong} <span class="text-gray-500 text-sm">(${giaPhong} đ/đêm)</span></label>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error("Lỗi tải danh sách phòng:", error);
                document.getElementById('phongSelectionContainer').innerHTML = '<p class="text-red-500">Lỗi tải phòng.</p>';
                alert(`Lỗi khi tải danh sách phòng: ${error.message}. Vui lòng kiểm tra console.`);
            }
        }

        /**
         * Tải danh sách nhân viên và điền vào dropdown.
         */
        async function loadEmployees() {
            try {
                const selectElement = document.getElementById('maNVThucHien');
                selectElement.innerHTML = '<option value="">-- Đang tải nhân viên --</option>';
                const res = await fetch('/api/nhanvien', { cache: 'no-cache' }); 
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP error! status: ${res.status}, body: ${errorText}`);
                }
                allEmployees = await res.json();
                selectElement.innerHTML = '<option value="">-- Chọn nhân viên thực hiện --</option>';
                allEmployees.forEach(nv => {
                    const option = document.createElement('option');
                    option.value = nv.ma_nv;
                    option.textContent = `${nv.ten_nv} (${nv.ma_nv})`;
                    selectElement.appendChild(option);
                });
            } catch (error) {
                console.error("Lỗi tải danh sách nhân viên:", error);
                document.getElementById('maNVThucHien').innerHTML = '<option value="">Lỗi tải nhân viên</option>';
            }
        }

        /**
         * Loads services from API and renders them with checkboxes and quantity inputs.
         */
        async function loadServices() {
            try {
                const container = document.getElementById('dichVuContainer');
                container.innerHTML = '<p class="text-gray-500">Đang tải dịch vụ...</p>'; // Show loading state

                const res = await fetch('/api/dichvu', { cache: 'no-cache' });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP error! status: ${res.status}, body: ${errorText}`);
                }
                allServices = await res.json();
                container.innerHTML = ''; // Clear loading message

                if (allServices.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Không có dịch vụ nào.</p>';
                    return;
                }

                allServices.forEach(dv => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2 border p-3 rounded-md bg-gray-50';
                    div.innerHTML = `
                        <input type="checkbox" id="service_${dv.ma_dv}" value="${dv.ma_dv}" class="form-checkbox h-4 w-4 text-blue-600" />
                        <label for="service_${dv.ma_dv}" class="flex-grow text-gray-800">${dv.ten_dv} <span class="text-gray-500 text-sm">(${dv.don_gia ? dv.don_gia.toLocaleString('vi-VN') : 'N/A'} đ)</span></label>
                        <input type="number" min="1" value="1" data-id="${dv.ma_dv}" 
                               class="border border-gray-300 px-2 py-1 rounded-md w-16 text-center text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" 
                               onfocus="this.select()" />
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error("Lỗi tải danh sách dịch vụ:", error);
                document.getElementById('dichVuContainer').innerHTML = '<p class="text-red-500">Lỗi tải dịch vụ.</p>';
                alert(`Lỗi khi tải danh sách dịch vụ: ${error.message}. Vui lòng kiểm tra console.`);
            }
        }

       
        async function datPhong() {
            const isNewCustomer = document.querySelector('input[name="khOption"]:checked').value === 'moi';
            let customerId = '';

            try {
                // 1. Validate inputs
                if (isNewCustomer) {
                    const tenKH = document.getElementById('tenKH').value.trim();
                    const sdtKH = document.getElementById('sdtKH').value.trim();
                    const cmndKH = document.getElementById('cmndKH').value.trim();
                    const ngaySinhKH = document.getElementById('ngaySinhKH').value;
                    const gioiTinhKH = document.getElementById('gioiTinhKH').value;

                    if (!tenKH || !sdtKH || !cmndKH || !ngaySinhKH || !gioiTinhKH) {
                        alert('Vui lòng điền đầy đủ thông tin khách hàng mới (Tên, SĐT, CCCD, Ngày sinh, Giới tính).');
                        return;
                    }
                    if (!/^\d{10}$/.test(sdtKH)) {
                        alert('Số điện thoại phải có đúng 10 chữ số.');
                        return;
                    }
                    if (!/^\d{12}$/.test(cmndKH)) {
                        alert('CCCD phải có đúng 12 chữ số.');
                        return;
                    }
                    if (new Date(ngaySinhKH) > new Date()) {
                        alert('Ngày sinh không thể ở tương lai.');
                        return;
                    }

                    const newCustomerPayload = {
                        ten_kh: tenKH,
                        sdt: sdtKH,
                        cmnd: cmndKH,
                        ngay_sinh: ngaySinhKH,
                        dia_chi: document.getElementById('diaChiKH').value.trim(),
                        gioi_tinh: gioiTinhKH,
                        quoc_tich: document.getElementById('quocTichKH').value.trim()
                    };

                    const res = await fetch('/api/khachhang', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newCustomerPayload)
                    });

                    if (!res.ok) {
                        const errorData = await res.json();
                        throw new Error(`Lỗi khi tạo khách hàng mới: ${errorData.message || res.statusText}`);
                    }
                    const data = await res.json();
                    customerId = data.ma_kh;
                } else {
                    customerId = document.getElementById('khachCuSelect').value;
                    if (!customerId) {
                        alert('Vui lòng chọn một khách hàng cũ.');
                        return;
                    }
                }

                // Lấy tất cả các phòng đã chọn từ checkboxes
                const selectedRoomCheckboxes = Array.from(document.querySelectorAll('#phongSelectionContainer input[name="selectedRooms"]:checked'));
                const roomIds = selectedRoomCheckboxes.map(checkbox => checkbox.value);

                if (roomIds.length === 0) {
                    alert('Vui lòng chọn ít nhất một phòng.');
                    return;
                }

                const checkinDate = document.getElementById('ngayNhan').value;
                const checkoutDate = document.getElementById('ngayTra').value;
                const bookingDate = document.getElementById('ngayDat').value;
                const hinhThucThanhToan = document.getElementById('hinhThucThanhToan').value;
                const maNVThucHien = document.getElementById('maNVThucHien').value;


                // Kiểm tra các trường ngày và hình thức thanh toán/nhân viên không rỗng
                if (!checkinDate || !checkoutDate || !bookingDate) {
                    alert('Vui lòng điền đầy đủ ngày đặt, ngày nhận, ngày trả.');
                    return;
                }
                if (!hinhThucThanhToan) {
                    alert('Vui lòng chọn hình thức thanh toán.');
                    return;
                }
                if (!maNVThucHien) {
                    alert('Vui lòng chọn nhân viên thực hiện.');
                    return;
                }

                // Date validation
                const d_booking = new Date(bookingDate);
                const d_checkin = new Date(checkinDate);
                const d_checkout = new Date(checkoutDate);

                if (d_booking > d_checkin) {
                    alert('Ngày nhận phòng không thể trước ngày đặt phòng.');
                    return;
                }
                if (d_checkin >= d_checkout) {
                    alert('Ngày trả phòng phải sau ngày nhận phòng.');
                    return;
                }

                // Lấy các dịch vụ đã chọn
                const selectedServices = Array.from(document.querySelectorAll('#dichVuContainer input[type=checkbox]:checked')).map(cb => {
                    const serviceId = cb.value;
                    const quantityInput = document.querySelector(`#dichVuContainer input[data-id="${serviceId}"]`);
                    const quantity = parseInt(quantityInput.value, 10);
                    
                    if (isNaN(quantity) || quantity < 1) {
                        throw new Error(`Số lượng dịch vụ ${allServices.find(s => s.ma_dv === serviceId)?.ten_dv || serviceId} không hợp lệ.`);
                    }
                    return { ma_dv: serviceId, so_luong: quantity };
                });

                // 2. Create Booking (DatPhong)
                const bookingPayload = {
                    ma_kh: customerId,
                    ma_phongs: roomIds, // Gửi một MẢNG các ID phòng tới backend
                    ngay_dat: bookingDate,
                    ngay_nhan: checkinDate,
                    ngay_tra: checkoutDate,
                    hinh_thuc_thanh_toan: hinhThucThanhToan, // Gửi hình thức thanh toán
                    ma_nv_thuc_hien: maNVThucHien, // Gửi mã nhân viên
                    dich_vu_da_dung: selectedServices // Gửi danh sách dịch vụ đã chọn
                };

                const bookingRes = await fetch('/api/datphong', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingPayload)
                });

                if (!bookingRes.ok) {
                    const errorData = await bookingRes.json();
                    throw new Error(`Lỗi khi tạo phiếu đặt phòng: ${errorData.message || res.statusText}`);
                }
                const bookingData = await bookingRes.json();
                const bookingId = bookingData.ma_phieu;
                const invoiceId = bookingData.ma_hd; // Lấy mã hóa đơn từ phản hồi

                alert('Đặt phòng thành công!');
                // Chuyển hướng đến trang chi tiết hóa đơn
                window.location.href = `hoadon.html?id=${invoiceId}`; 

            } catch (error) {
                console.error("Lỗi đặt phòng:", error);
                alert(`Đặt phòng thất bại: ${error.message}`);
            }
        }

        // --- Initial Load on Page ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set current date as default for "Ngày đặt"
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ngayDat').value = today;

            loadOldCustomers();
            loadEmployees(); // Tải danh sách nhân viên
            loadServices();
            // Ban đầu không tải phòng, chờ người dùng chọn ngày nhận/trả
            document.getElementById('phongSelectionContainer').innerHTML = '<p class="text-gray-500">Vui lòng chọn Ngày nhận và Ngày trả phòng.</p>';
        });
    </script>
</body>
</html>
